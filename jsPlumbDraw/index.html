<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JsPlumb Draw</title>
    <!-- 引入layui的主要样式表 -->
    <link rel="stylesheet" href="../layui/css/layui.css">
    <!-- 引入jQueryUI的样式表 -->
    <link rel="stylesheet" href="../jsplumb/jquery-ui.min.css">
    <!-- 引入流程设计的样式 -->
    <link rel="stylesheet" href="../jsplumb/flow_design.css">
    <!-- 引入shape的样式 -->
    <link rel="stylesheet" href="../jsPlumbDraw/shape.css">
    <style>
    * {
        margin: 0;
        padding: 0;
    }
    .layui-fluid {
        padding: 5px;
    }
    .layui-card {
        border: 1px solid #eeeeee;
    }
    .layui-card-header {
        border-bottom: 1px solid #5FB878;
    }
    .btn-container {
        max-height: 800px;
	    overflow-y: auto;
    }
    .btn-container .btn-node {
        border: 1px solid #C9C9C9;
        background-color: #fff;
        color: #555;
        height: 30px;
        line-height: 30px;
        padding: 0 10px;
        font-size: 12px;
        border-radius: 2px;
        cursor: pointer;
        white-space: nowrap;
        text-align: center;
        display: inline-block;
        box-sizing: border-box;
        vertical-align: middle;
        margin-right: 5px;
        margin-bottom: 5px;
        z-index: 2;
    }
    .btn-container .btn-node:hover {
        border: 1px solid #009688;
    }
    #flow-container {
        min-height: 600px;
		background-image: linear-gradient(90deg, rgba(156, 144, 144, 0.15) 10%, rgba(0, 0, 0, 0) 10%), linear-gradient(rgba(105, 99, 99, 0.15) 10%, rgba(0, 0, 0, 0) 10%);
		background-size: 10px 10px;
		position: relative;
		overflow: auto;
    }
    .shape-menu {
        border-radius: 2px;
        box-shadow: 1px 1px 50px rgba(0,0,0,.3);
        background-color: #5fb878;
        padding: 5px 0 5px 0;
    }
    .shape-menu a {
        display: block;
        padding: 5px 20px;
        color: #fff;
        transition: all .3s;
        -webkit-transition: all .3s;
        font-size: 12px;
    }
    .shape-menu a:hover {
        color: darkviolet;
    }
    </style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <div class="layui-btn-group">
                <button type="button" class="layui-btn layui-btn-sm" title="保存" data-type="save">
                    <i class="layui-icon">&#xe655;</i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm" title="添加节点">
                    <i class="layui-icon">&#xe61f;</i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm" title="编辑点击元素">
                    <i class="layui-icon">&#xe642;</i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm" title="删除点击元素">
                    <i class="layui-icon">&#xe640;</i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm" title="连线">
                    <i class="layui-icon">&#xe674;</i>
                </button>
                <button type="button" class="layui-btn layui-btn-sm" title="提示及帮助">
                    <i class="layui-icon">&#xe60b;</i>
                </button>
            </div>
        </div>
    </div>
    <div class="layui-row layui-col-space10">
        <div class="layui-col-md2">
            <div class="layui-card">
				<div class="layui-card-header">步骤块区</div>
				<div class="layui-card-body">
					<div class="btn-container">
                        <!-- 放置步骤区块 -->
                        <div class="shape diamond_outer" data-shape="diamond">
                            <div class="diamond_text">菱形(决策)</div>
                            <div class="diamond_top"></div>
                            <div class="diamond_bottom"></div>
                        </div>
                        <div class="shape rectangle_outer" data-shape="rectangle">
                            <div class="rectangle_text">矩形(过程)</div>
                            <div class="rectangle_top"></div>
                            <div class="rectangle_bottom"></div>
                        </div>
                        <div class="shape roundedRect_outer" data-shape="roundedRect">
                            <div class="roundedRect_text">圆角矩形(可选过程)</div>
                            <div class="roundedRect_top"></div>
                            <div class="roundedRect_bottom"></div>
                        </div>
                        <div class="shape arcRect_outer" data-shape="arcRect">
                            <div class="arcRect_text">圆弧矩形(开始/结束)</div>
                            <div class="arcRect_top"></div>
                            <div class="arcRect_bottom"></div>
                        </div>
                        <div class="shape hexagon_outer" data-shape="hexagon">
                            <div class="hexagon_text">六边形(准备)</div>
                            <div class="hexagon_top"></div>
                            <div class="hexagon_bottom"></div>
                        </div>
					</div>
				</div>
			</div>
        </div>
        <div class="layui-col-md7">
            <div class="layui-card">
				<div class="layui-card-header">流程图示区</div>
				<div class="layui-card-body">
					<div class="flow-container" id="flow-container">
						<!-- 放置流程设计图的容器 -->
					</div>
				</div>
			</div>
        </div>
        <div class="layui-col-md3">
            <div class="layui-card">
				<div class="layui-card-header">步骤逻辑区</div>
				<div class="layui-card-body">
					<div class="logic-container">
                        <!-- 步骤逻辑区 -->
					</div>
				</div>
			</div>
        </div>
    </div>
</div>

<!-- 克隆到流程容器的模板节点 -->
<script type="text/html" id="shapeNode">
    <div id="{{ d.id }}" data-json="{{ d.jsonNode }}" style="top: {{ d.top }}px; left: {{ d.left }}px; cursor: Move;" class="item-shape-node {{ d.shape }}_outer">
        <i class="layui-icon layui-icon-close-fill"></i>
        <div class="{{ d.shape }}_text">
            <span class="nodeName">{{ d.name }}</span>
        </div>
        <div class="{{ d.shape }}_top"></div>
        <div class="{{ d.shape }}_bottom"></div>
    </div >
</script>

<!-- 引入layui的js文件 -->
<script src="../layui/layui.js"></script>
<script>
layui.config({
    base: 'file:///D:/' // 配置layui第三方插件存放的基础路径，自由更改
}).extend({
    jqui: '/drawFlow/jsplumb/jQueryUI.min',
    jsPlumb: '/drawFlow/jsplumb/jquery_jsplumb_forlayui.min',
    draw: '/drawFlow/jsPlumbDraw/config',
}).use(['laytpl', 'layer', 'jsPlumb', 'jqui', 'draw'], function() {
    var $ = layui.jquery, laytpl = layui.laytpl, jsPlumb = layui.jsPlumb, draw = layui.draw,
        layer = layui.layer;

    var fun = {
        mockMakeUUID: function() { // 模拟生成uuid
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        },
        guid: function() { // 生成uuid的长串
            return (this.mockMakeUUID() + this.mockMakeUUID() + "-" + this.mockMakeUUID() + "-" + this.mockMakeUUID() + "-" 
                    + this.mockMakeUUID() + "-" + this.mockMakeUUID() + this.mockMakeUUID() + this.mockMakeUUID());
        },
        renderShapeNode: (_data) => {
            var uuid = fun.guid();
            var data = $.extend(true, {
                id: uuid
            }, _data);
            laytpl($('#shapeNode').html()).render(data, function(_html) {
                $('#flow-container').append(_html);
            });
            jsPlumb.makeSource(uuid, {
                anchor: [[0.2, 0, 0, 0], "Top", "Right", "Bottom", "Left", "BottomLeft", /*"TopRight",*/ "TopLeft", "BottomRight"], // 可以使用 Continuous 属性，产生锚点位置
                allowLoopback: false, //禁止回环
                filter: function (_ev, _ele) {
                    var tar = _ev.target.tagName;
                    if (tar === 'SPAN' || tar === 'I') {
                        // 过滤这两个标签不创造端点
                        return false;
                    }
                },
            }, draw.config);
            jsPlumb.draggable(uuid, {
                containment: "parent"
            });
        },
        cloneShapeNode: () => {
            var uuid = fun.guid();
            $('.shape').draggable({
                helper: 'clone',
                scope: "shapeNode"
            });
            $('#flow-container').droppable({
                scope: "shapeNode",
                drop: function (_event, _ui) {
                    var data = {
                        shape: _ui.helper.data('shape'),
                        name: _ui.helper.text(),
                        top: _ui.position.top,
                        left: _ui.position.left - $('.layui-col-md2').outerWidth(),
                        jsonNode: []
                    };
                    fun.renderShapeNode(data);
                }
            });
        }
    };

    var active = {
        delNode: function(_nodeId) {
            jsPlumb.remove(_nodeId);
        },
        save: function() {
            console.log(jsPlumb.getAllConnections()); // 可以获取所有的连线集
            console.log($('#flow-container').children('.item-node')); // 获取所有的节点
        },
        editForm: function() {
            layer.closeAll();
            layer.open({
                title: false,
                content: '<div>11</div>',
                area: ['80%'],
                btn: false,
                shadeClose: true,
                cancel: function() {
                    // 点击右上角的关闭按钮，触发回调
                }
            });
        },
        del: function(_id) {
            layer.confirm('是否要删除此节点', { icon: 3, title: '提示' }, function () {
                active.delNode(_id);
                layer.closeAll();
            }, function (_index) {
                layer.msg('你已取消删除此节点操作');
                layer.close(_index);
            });
        }
    };

    // 单击按钮触发事件
    $('.layui-btn').on('click', function(e) {
        var type = $(this).data('type');
        if (active[type]) {
            active[type].call(this, e);
        }
    });

    // 点击图形菜单时触发的事件
    $(document).on('click', '.shape-menu a', function() {
        var type = $(this).data('type'), id = $(this).data('id');
        if (active[type]) {
            active[type].call(this, id);
        }
    });

    jsPlumb.ready(function() {
        jsPlumb.setContainer('flow-container'); // 设置画布容器节点
        fun.cloneShapeNode();
    });
    // jsPlumb.importDefaults({
    //     ConnectionsDetachable: false // 是否拖动锚点断开连接
    // });
    
    // 连接前的检查，判断是否建立连接,避免连线源锚点和目标锚点在同一节点上
    jsPlumb.bind('beforeDrop', function (_info) {
        if (_info.sourceId === _info.targetId) {
            return false;
        }else{
            return true;
        }
    });

    // 操作按钮组的功能组
    $('.layui-btn-group .layui-btn').on('click', function() {
        var btnGroup = $('.layui-btn-group').children('.layui-btn');
        for(var i = 0; i < btnGroup.length; i++) {
            var ele = btnGroup[i];
            if ($(this).attr('title') === $(ele).attr('title')) {
                $(this).addClass('layui-btn-primary');
            }else{
                $(ele).removeClass('layui-btn-primary');
            }
        }
        return false;
    });

    // 单击节点相关事件操作
    $(document).on('click', '#flow-container .item-shape-node', function(e) {
        var nodeId = this.id;
        var className = e.target.className; // 获取点击
        // console.log(className);
        if (className === 'layui-icon layui-icon-close-fill') {
            layer.confirm('是否要删除此节点', { icon: 3, title: '提示' }, function(_index) {
                active.delNode(nodeId);
                layer.close(_index);
            }, function() {
                layer.msg('你已取消删除此节点操作');
            });
        }
    });

    // 双击节点文本事件操作
    $(document).on('dblclick', '#flow-container .item-node', function(e) {
        var t = ($(this).text()).replace(/(^\s*)|(\s*$)/g, ""); // 获取当前点击的节点文本值，并去除前后空格
        var className = e.target.className; // 获取点击
        var thisId = $(e.target).parent().attr('id'); // 获取所点击的id
        if (className === 'nodeName') {
            layer.prompt({ title: '重新命名文本框', formType: 0, value: t }, function(_text, _index) {
                layer.close(_index);
                $('#' + thisId + ' .nodeName').text(_text); // 将新值赋值到所点击的元素上
                // 有个bug，可能需要重新绘制一下图形，不绘制的话可能会无法正确显示锚点
            });
        }
    });

    $(document).keydown(function (e) {
        // console.log(e.keyCode, e.key); // 键值和键名
        if (e.keyCode === 27) { // 当用户按下esc时清空按钮组的样式
            $('.layui-btn-group .layui-btn').removeClass('layui-btn-primary');
        }
        if (e.ctrlKey && e.keyCode === 86) { // 组合键的判断 Ctrl+v
            console.log('你按下了ctrl+V');
        }
        if (e.keyCode === 46) {
            // delte键 to do
            // active.del();
        }
    });

    // 鼠标右键功能
    // 禁用某元素组织右键点击事件
    $(document).on("contextmenu", "div", function () {
        return false;
    });

    // 激活item-shape-node右键功能，弹出节点菜单
    $(document).on('mousedown', '#flow-container .item-shape-node', function (e) {
        var k = e.which, id = this.id;
        if (3 === k) {
            var x = e.clientX;
            var y = e.clientY;
            layer.closeAll();
            var html = '<div class="shape-menu">\
                            <a href="javascript:;" data-id="' + id +'" data-type="copy">复制节点</a>\
                            <a href="javascript:;" data-id="' + id +'" data-type="del">删除节点</a>\
                            <a href="javascript:;" data-id="' + id +'" data-type="editForm">编辑表单</a>\
                        </div>';
            layer.open({
                title: false,
                closeBtn: 0,
                type: 1,
                shade: 0,
                offset: [y, x],
                area: ['120px'],
                fixed: false,
                content: html
            });
        }else{
            return false;
        }
    });

    // 单击鼠标任何键位，撤销弹出层
    $('div').on('mousedown', function (e) {
        layer.closeAll();
    });

});
</script>
</body>
</html>